{# taller_core/gestion/templates/gestion/dashboard.html #}
{% extends "gestion/base.html" %}
{% load static json_script %}

{% block title %}Dashboard - Taller Mecánico{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="fas fa-tachometer-alt"></i> Dashboard del Taller</h1>
    </div>
</div>

{# Alertas #}
{% if alertas %}
<div class="alert alert-warning">
    <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Alertas Activas</h5>
    <ul>
        {% for alerta in alertas %}
        <li>{{ alerta.mensaje }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{# Tarjetas de estadísticas #}
<div class="row mb-4">
    <div class="col-md-3"><div class="card text-center bg-info text-white"><div class="card-body"><h2>{{ stats.recepcionadas }}</h2><p>Recepcionadas</p></div></div></div>
    <div class="col-md-3"><div class="card text-center bg-primary text-white"><div class="card-body"><h2>{{ stats.en_diagnostico }}</h2><p>En Diagnóstico</p></div></div></div>
    <div class="col-md-3"><div class="card text-center bg-warning text-dark"><div class="card-body"><h2>{{ stats.en_reparacion }}</h2><p>En Reparación</p></div></div></div>
    <div class="col-md-3"><div class="card text-center bg-success text-white"><div class="card-body"><h2>{{ stats.listas }}</h2><p>Listas</p></div></div></div>
</div>

{# Gráfico y Órdenes Recientes #}
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Distribución de Órdenes Activas</div>
            <div class="card-body">
                <canvas id="estadosChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Órdenes Recientes</div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead><tr><th>ID</th><th>Vehículo</th><th>Estado</th></tr></thead>
                    <tbody>
                        {% for orden in ordenes_recientes %}
                        <tr>
                            <td>#{{ orden.id }}</td>
                            <td>{{ orden.vehiculo.patente }}</td>
                            <td><span class="badge bg-info">{{ orden.get_estado_display }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% json_script stats "stats-data" %}
<script>
const stats = JSON.parse(document.getElementById('stats-data').textContent);
const ctx = document.getElementById('estadosChart');
if (ctx) {
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Recepcionadas', 'En Diagnóstico', 'En Reparación', 'Listas'],
            datasets: [{
                data: [stats.recepcionadas, stats.en_diagnostico, stats.en_reparacion, stats.listas],
                backgroundColor: ['#17a2b8', '#007bff', '#ffc107', '#28a745']
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'top' } }
        }
    });
}
</script>
{% endblock %}
